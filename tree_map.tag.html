
<tree_map>
    <div style="width:100%; height:100%;" ref="canvas_holder">
        <canvas ref="canvas">
        </canvas>
    </div>

    <script>
        var self = this;

        
        self.private = {

            // ファイルツリー
            tree: null,

            //　描画
            draw: function() {
                if (!self.private.tree) {
                    return;
                }

                var canvas = self.refs.canvas;
                var width = canvas.width;
                var height = canvas.height;
                var areas = treeMap.createTreeMap(self.private.tree, width, height);

                var fillStyle = [];
                var strokeStyle = [];
                for (var i = 0; i < 10; i++) {
                    fillStyle.push("hsl(" + ((0+i*30)%360) + ", 40%, 70%)");
                    strokeStyle.push("hsl(" + ((0+i*30)%360) + ", 20%, 40%)");
                }

                var c = self.refs.canvas.getContext('2d');
                for (var i = 0; i < areas.length; i++) {
                    var rect = areas[i].rect;
                    
                    // レベルに応じた色にする
                    c.fillStyle = fillStyle[areas[i].level];
                    c.fillRect(rect[0], rect[1], rect[2] - rect[0], rect[3] - rect[1]);

                    // 枠線の太さもレベルに応じる
                    c.lineWidth = Math.max(2 - areas[i].level/2, 0.5); 
                    // 枠線の色は，基準色から明度をおとしたものに
                    c.strokeStyle = strokeStyle[areas[i].level];
                    c.strokeRect(rect[0], rect[1], rect[2] - rect[0], rect[3] - rect[1]);
                }

                for (var i = 0; i < areas.length; i++) {
                    var rect = areas[i].rect;

                    // 文字領域が確保できた場合は描画
                    if (rect[2] - rect[0] > 80 && rect[3] - rect[1] > 40) {

                        // 1回太めに文字の枠線を書く
                        c.font = 'bold 15px Century Gothic';
                        c.lineWidth = 4; 
                        c.strokeStyle = strokeStyle[areas[i].level];
                        c.strokeText(areas[i].key, rect[0] + 5, rect[1] + 15 + 5);

                        // 次に白を重ねて書く
                        c.fillStyle = 'rgb(255,255,255)';
                        c.fillText(areas[i].key, rect[0] + 5, rect[1] + 15 + 5);
                    }
                }


            },

            // リサイズハンドラ
            onResize: function() {
                // CSS で指定するとぼける
                // キャンバスのサイズを無理矢理変更する必要がある
                var canvas = self.refs.canvas;
                var canvas_holder = self.refs.canvas_holder;
                canvas.width = canvas_holder.offsetWidth;
                // navbar の分を引く
                canvas.height = canvas_holder.offsetHeight; // - self.tags.app_navbar.getHeight();
                self.private.draw();
            },


            // 初期化
            // タグのマウント時に呼ばれるようにする
            init: function(callback) {
                // ウィンドウのリサイズハンドラ
                window.addEventListener("resize", self.private.onResize, false);

                self.private.onResize(); // サイズを適用するために1回呼んどく
            },        
        };

        self.setTree = function(tree) {
            self.private.tree = tree;
            self.private.draw();
        }

        // エントリポイント
        // マウント時に初期化を行う
        self.on("mount", self.private.init);

    </script>
</tree_map>

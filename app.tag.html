
<!-- The navigation ber at the top of the window -->
<app_navbar>
    <!-- 下にマージンがはいるので，つぶしておく -->
    <nav class="navbar navbar-default" ref="app_navbar" style="margin:0px;">
        <div class="container-fluid">

            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#id_app_navbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span> 
                </button>
                <div class="navbar-brand">
                    {title}
                </div>
            </div>
            
            <div class="collapse navbar-collapse" id="id_app_navbar">
                <!-- "navbar-right" alignes items to the right side-->
                <ul class="nav navbar-nav navbar-left">
                    <li><a href="#home" onclick={onClickOpen}>
                        <span class="glyphicon glyphicon-folder-open"></span> 
                        フォルダを開く
                    </a></li>
                    <li><a href="#home" onclick={onClickZoomIn}>
                        <span class="glyphicon glyphicon-zoom-in"></span> 
                        拡大
                    </a></li>
                    <li><a href="#home" onclick={onClickZoomOut}>
                        <span class="glyphicon glyphicon-zoom-out"></span> 
                        縮小
                    </a></li>
                </ul>
            </div>

        </div>
    </nav>

    <script>
        let self = this;

        self.title = "";
        self.onOpen = null;
        self.onZoomIn = null;
        self.onZoomOut = null;

        // Close the dropdown list
        self.closeDropDown = function(){
            $("div#id_app_navbar").collapse("hide");
        };

        // "Open folder" is clicked
        self.onClickOpen = function() {
            self.closeDropDown();   // Close the list after click
            self.onOpen();    // 外部から登録されたハンドラの呼び出し
        };
        self.onClickZoomIn = function() {
            self.closeDropDown();   // Close the list after click
            self.onZoomIn();    // 外部から登録されたハンドラの呼び出し
        };
        self.onClickZoomOut = function() {
            self.closeDropDown();   // Close the list after click
            self.onZoomOut();    // 外部から登録されたハンドラの呼び出し
        };

        // 高さを取得
        self.getHeight = function() {
            return self.refs["app_navbar"].offsetHeight;
        };

    </script>
</app_navbar>


<!-- Application -->
<app>

    <!-- Navigation ber -->
    <app_navbar ref="app_navbar">
    </app_navbar>

    <!-- ツリーマップ -->
    <div ref="canvas_holder">
        <tree_map_canvas ref="tree_map_canvas"></tree_map_canvas>
    </div>

    <!-- メッセージ -->
    <div class="panel panel-info" style="margin:0px;" ref="status_bar">
        <div class="panel-heading">
            {statusBarMessage}
	    </div>
    </div>

    <!-- Notification dialog
        This dialog is not visible in usual.
     -->
    <modal_dialog></modal_dialog>


    <script>
        let self = this;

        // メニュー
        let menuTemplate = [
            {
                label: "ファイル",
                submenu: [{
                    label: "フォルダを開く",
                    click: function(){self.openFolder();}
                }]
            },
            {
                label: "ヘルプ",
                submenu: [
                    {
                        label: "開発者ツールの切り替え",
                        click: function(){self.toggleDevTools();}
                    },
                    {
                        label: "バージョン情報",
                        click: function(){self.modalDialog("agate 0.1, Ryota Shioya");}
                    }
                ]
            }
        ];

        self.statusBarMessage = "フォルダを開いてください";    // 
        self.remote = require("electron").remote;

        // ダイアログを表示
        self.modalDialog = function(msg){
            self.tags.modal_dialog.modal_message(msg);
        };

        // 開発者ツールのオンオフ
        self.toggleDevTools = function(){
            let win = self.remote.getCurrentWindow();
            if (win.isDevToolsOpened()) {
                win.closeDevTools();
            }
            else {
                win.openDevTools();
            }
        };

        // フォルダのオープン
        self.openFolder = function(){

            const dialog = self.remote.dialog;
            /* global FileInfo */
            let fileInfo = new FileInfo();

            dialog.showOpenDialog(
                null, {
                    properties: ["openDirectory"],
                    title: "フォルダを選んでください",
                    defaultPath: "."
                },
                function(folderName){
                    if (!folderName) {
                        return;
                    }
                    fileInfo.getFileTree(
                        folderName[0],  // 配列で渡される
                        function(context, tree) {
                            self.refs.tree_map_canvas.setTree(tree);
                            self.statusBarMessage = 
                                "\"" + folderName[0] + "\"から " + 
                                context.count + " 個のファイル/フォルダを読み込みました";
                            self.update();
                            self.onResize();
                        },
                        function(context, filePath) {
                            self.statusBarMessage = 
                                "" + context.count + " 個のファイル/フォルダを読み込みました．" + 
                                "現在 \"" + filePath + "\" を読み込んでいます．";
                            self.update();
                            self.onResize();
                        }
                    );
                }
            );
        };

        // リサイズハンドラ
        self.onResize = function(){
            // CSS で指定するとぼける
            // キャンバスのサイズを無理矢理変更する必要がある
            let canvas = self.refs.tree_map_canvas;
            let canvasHolder = self.refs.canvas_holder;

            canvasHolder.style.width = "" + document.body.offsetWidth + "px";

            let bodyHeight = 
                document.body.offsetHeight - 
                self.tags.app_navbar.getHeight() -
                self.refs.status_bar.offsetHeight;
            canvasHolder.style.height = "" + bodyHeight + "px";

            canvas.width = canvasHolder.offsetWidth;
            canvas.height = canvasHolder.offsetHeight;
            canvas.update();
        };

        // 初期化
        // タグのマウント時に呼ばれるようにする
        self.init = function(){
            // メニューを追加
            let Menu = self.remote.Menu;
            let menu = Menu.buildFromTemplate(menuTemplate);
            Menu.setApplicationMenu(menu);
            
            // リサイズハンドラの設定
            window.addEventListener("resize", self.onResize, false);
            self.onResize();    // サイズを適用しておくために1回呼んでおく

            // フォルダを開くのバインド
            self.refs.app_navbar.onOpen = self.openFolder;
            self.refs.app_navbar.onZoomIn = self.refs.tree_map_canvas.zoomIn;
            self.refs.app_navbar.onZoomOut = self.refs.tree_map_canvas.zoomOut;

            // パスが変わったときのハンドラの設定
            self.refs.tree_map_canvas.onPointedPathChanged = function(path, fileNode){
                if (!path) {
                    return;
                }

                function sizeToStr(size) {
                    if (size > 1024*1024) {
                        return "" + Math.ceil(size/1024/1024) + " MB";
                    }
                    else if (size > 1024) {
                        return "" + Math.ceil(size/1024) + " KB";
                    }
                    else {
                        return "" + size + " B";
                    }
                }

                self.statusBarMessage = path + " [" + sizeToStr(fileNode.size) + "]";
                self.update();
                self.onResize();
            };

            // 一回開く
            self.openFolder();
        };

        // エントリポイント
        // マウント時に初期化を行う
        self.on("mount", self.init);

    </script>
</app>


